MAnorm {WIP}
============
My modified/improved version for testing.

Original can be found [here](http://bcb.dfci.harvard.edu/~gcyuan/MAnorm/R_tutorial.html) 
Published in [Genome Biology 2012](http://www.ncbi.nlm.nih.gov/pubmed/22424423)

Problems with MAnorm
--------------------
* There is something wrong with how the p-values are calculated (see code in MAnorm2.R for details). 
  * pval calculation is not optimized (very slow)
    * It is faster to use choose() and run in parallel
  * Stirling approximation seems to be [done incorrectly](http://stats.stackexchange.com/questions/47997/unknown-p-value-calculation)
    * This calculation is consistant in matlab file (more details in matlab file than R file)
  * pval are not symmetric (calculations from x/y do not give the same pvalues as y/x)
* mergeBed command in MAnorm.sh does not actually work (need to sort first)
* Lots of tmp files generated by MAnorm.sh and a lot of steps could be done in parallel
  
Changes in v3
-------------
This version uses [edgeR](http://www.bioconductor.org/packages/release/bioc/html/edgeR.html) for significance testing.
* Requires 2 replicates (since [ENCODE samples](http://ftp.ebi.ac.uk/pub/databases/ensembl/encode/integration_data_jan2011/byDataType/mappedReads/) have 2 replicates)
* Run bedtools in parallel (faster unless you have IO bottleneck)
* Added Parameter for output directory specification
* MA adjustment is included as an offset to edgeR model
* sortBed before mergeBed command so the merged dataset is actually merged
* Requires input to be gzipped (will add switch for this later)

Todo
----
* Contact MAnorm author about some of the issues in p-value calculation and merging
* Add switch for gzip
* Add error checks and helpeful diagnostic messages

Changes in v2
-------------
This version tries to keep the same output as original MAnorm but has the following changes:
* I run bedtools in parallel in the background for significant speedup.
* Allows replicates (see read in part of MAnorm2.sh)
  * Concatenates replicates (proper way would be to downsample so replicates have equal weight)
  * Not well tested code was merged in from MAnorm3

Experience from running on a quad core workstation with 32gb of ram: 
* StepI is I/O bound (mostly reading from disk and writing back to disk)
* StepII & StepIII is CPU bound (lots of parallel bedtools)
* Ram usage I've seen with ENCODE datasets is 20gb+/-5gb but I dont actually think all of this is used for processing

v2 will retain the same input/output as the original script (from supplement of paper) but will be faster
v3 will have different input/output options but the same methods will be applied

Example of MAnorm3 run:
```bash
MAnorm3.sh peaks_folder \
  peaksA.bed.gz \
  peaksB.bed.gz \
  readsA1.bed.gz \
  readsA2.bed.gz \
  readsB1.bed.gz \
  readsB2.bed.gz \
  60 70 55 53
```
      
Where 60 70 55 53 correspond to shift lengths (half of estimated fragment length) for `readsA1.bed readsA2.bed readsB1.bed readsB2.bed` 
and `readsA1` and `readsA2` are replicates used to identify peaks in `peaksA`. You must have MAnorm3.R and MAnorm3.sh in your {PATH}